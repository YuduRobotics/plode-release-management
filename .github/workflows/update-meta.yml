name: Firmware Versioning & Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  firmware-release:
    runs-on: ubuntu-latest

    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq & yq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip
          pip3 install yq

      - name: Detect changed firmware folder
        id: detect
        run: |
          echo "Searching for changes inside ZG folders..."

          changed=$(git diff --name-only HEAD~1 HEAD | grep -E '^ZG[0-9]+\.[0-9]+/' || true)

          if [ -z "$changed" ]; then
            echo "No firmware changes detected."
            echo "changed_folder=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ZG3.1/actions/action.bin â†’ extract "ZG3.1"
          folder=$(echo "$changed" | head -n1 | cut -d'/' -f1)

          if [ ! -d "$folder" ]; then
            echo "ERROR: Folder '$folder' does not exist!"
            exit 1
          fi

          echo "Detected firmware folder: $folder"
          echo "changed_folder=$folder" >> $GITHUB_OUTPUT

      - name: Stop if nothing to release
        if: steps.detect.outputs.changed_folder == ''
        run: echo "No firmware updates."

      - name: Set folder paths
        id: paths
        run: |
          folder="${{ steps.detect.outputs.changed_folder }}"
          meta="${folder}/meta.yaml"

          echo "folder=$folder" >> $GITHUB_OUTPUT
          echo "meta=$meta" >> $GITHUB_OUTPUT

      - name: Ensure meta.yaml exists
        run: |
          meta="${{ steps.paths.outputs.meta }}"
          folder="${{ steps.paths.outputs.folder }}"

          if [ ! -f "$meta" ]; then
            echo "Creating new meta.yaml for $folder ..."
            {
              echo "firmware: \"$folder\""
              echo "version: \"0.0.0\""
              echo "last_updated: \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\""
              echo "files: {}"
            } > "$meta"
          fi

      - name: Increment firmware version
        id: version
        run: |
          meta="${{ steps.paths.outputs.meta }}"
          old=$(yq e '.version' "$meta")

          IFS='.' read -r major minor patch <<< "$old"
          patch=$((patch + 1))
          new="$major.$minor.$patch"

          echo "Old version: $old"
          echo "New version: $new"

          echo "new_version=$new" >> $GITHUB_OUTPUT

      - name: Update per-file versions
        run: |
          folder="${{ steps.paths.outputs.folder }}"
          meta="${{ steps.paths.outputs.meta }}"

          # Convert YAML to JSON
          yq e '.files' "$meta" | yq -o=json > files.json

          git diff --name-only HEAD~1 HEAD \
            | grep "^$folder/" \
            | cut -d'/' -f2- \
            > changed_files.txt || true

          while read file; do
            [ -z "$file" ] && continue

            if jq -e ".\"$file\"" files.json > /dev/null 2>&1; then
              old=$(jq -r ".\"$file\".version" files.json)
              IFS='.' read -r a b c <<< "$old"
              c=$((c+1))
              new="$a.$b.$c"
            else
              new="0.0.1"
            fi

            jq ".\"$file\"={version:\"$new\", last_updated:\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}" \
              files.json > tmp.json && mv tmp.json files.json

          done < changed_files.txt

          {
            echo "firmware: \"${{ steps.detect.outputs.changed_folder }}\""
            echo "version: \"${{ steps.version.outputs.new_version }}\""
            echo "last_updated: \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\""
            echo "files:"
            jq -r 'to_entries | .[] | 
              "  \(.key):\n    version: \"\(.value.version)\"\n    last_updated: \"\(.value.last_updated)\""'
          } > "$meta"

      - name: Commit updated meta.yaml
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "${{ steps.paths.outputs.meta }}"
          git commit -m "Update ${{ steps.detect.outputs.changed_folder }} to v${{ steps.version.outputs.new_version }} [skip ci]" || echo "No changes"
          git push

      - name: Create Release Tags
        id: tags
        run: |
          fw="${{ steps.detect.outputs.changed_folder }}"
          ver="${{ steps.version.outputs.new_version }}"

          tag="${fw}-v${ver}"
          latest="${fw}-latest"

          echo "Creating tag: $tag"
          git tag "$tag"
          git push origin "$tag"

          echo "Updating latest tag: $latest"
          git tag -f "$latest"
          git push origin -f "$latest"

          echo "tag_name=$tag" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tags.outputs.tag_name }}
          name: "Firmware ${{ steps.detect.outputs.changed_folder }} v${{ steps.version.outputs.new_version }}"
          files: |
            ${{ steps.paths.outputs.folder }}/**
          draft: false
          prerelease: false
