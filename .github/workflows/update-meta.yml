name: Firmware Versioning & Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  firmware-release:
    runs-on: ubuntu-latest

    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq & yq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip
          pip3 install yq

      ###############################################
      # 1. Detect changed firmware folder
      ###############################################
      - name: Detect changed firmware folder
        id: detect
        run: |
          echo "=== Detecting changed firmware folders ==="

          # Detect changed files inside ANY ROOT FOLDER except .github
          changed=$(git diff --name-only HEAD~1 HEAD | grep -v '^\.github/' | grep '/' || true)

          echo "Changed files:"
          echo "$changed"

          if [ -z "$changed" ]; then
            echo "changed_folder=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract root folder name (before first /)
          folder=$(echo "$changed" | head -n1 | cut -d'/' -f1)

          echo "Detected firmware folder: $folder"
          echo "changed_folder=$folder" >> $GITHUB_OUTPUT

      ###############################################
      # 2. Stop if no firmware folder changed
      ###############################################
      - name: Stop if nothing to release
        if: steps.detect.outputs.changed_folder == ''
        run: |
          echo "âœ… No firmware folder changed. Stopping pipeline."
          exit 0

      ###############################################
      # 3. Set paths
      ###############################################
      - name: Set folder paths
        id: paths
        run: |
          folder="${{ steps.detect.outputs.changed_folder }}"
          meta="${folder}/meta.yaml"
          echo "folder=$folder" >> $GITHUB_OUTPUT
          echo "meta=$meta" >> $GITHUB_OUTPUT

      ###############################################
      # 4. Ensure meta.yaml exists
      ###############################################
      - name: Ensure meta.yaml exists
        run: |
          meta="${{ steps.paths.outputs.meta }}"
          folder="${{ steps.paths.outputs.folder }}"

          echo "Meta file should be: $meta"

          if [ ! -f "$meta" ]; then
            echo "Creating new meta.yaml for $folder ..."
            {
              echo "firmware: \"$folder\""
              echo "version: \"0.0.0\""
              echo "last_updated: \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\""
              echo "files: {}"
            } > "$meta"
          fi

      ###############################################
      # 5. Increment firmware version
      ###############################################
      - name: Increment firmware version
        id: version
        run: |
          meta="${{ steps.paths.outputs.meta }}"
          old=$(yq e '.version' "$meta")

          IFS='.' read -r major minor patch <<< "$old"
          patch=$((patch + 1))
          new="$major.$minor.$patch"

          echo "New firmware version: $new"
          echo "new_version=$new" >> $GITHUB_OUTPUT

      ###############################################
      # 6. Update per-file versions
      ###############################################
      - name: Update per-file versions
        run: |
          folder="${{ steps.paths.outputs.folder }}"
          meta="${{ steps.paths.outputs.meta }}"

          yq e '.files' "$meta" | yq -o=json > files.json

          # Detect changed files inside THIS firmware folder
          git diff --name-only HEAD~1 HEAD \
            | grep "^$folder/" \
            | cut -d'/' -f2- \
            > changed_files.txt || true

          while read file; do
            [ -z "$file" ] && continue

            # Existing file
            if jq -e ".\"$file\"" files.json > /dev/null 2>&1; then
              old=$(jq -r ".\"$file\".version" files.json)
              IFS='.' read -r a b c <<< "$old"
              c=$((c+1))
              new="$a.$b.$c"
            else
              new="0.0.1"  # New file
            fi

            jq ".\"$file\" = {version:\"$new\", last_updated:\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}" \
              files.json > tmp.json && mv tmp.json files.json

          done < changed_files.txt

          {
            echo "firmware: \"${{ steps.detect.outputs.changed_folder }}\""
            echo "version: \"${{ steps.version.outputs.new_version }}\""
            echo "last_updated: \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\""
            echo "files:"
            jq -r 'to_entries | .[] | "  \(.key):\n    version: \"\(.value.version)\"\n    last_updated: \"\(.value.last_updated)\""'
          } > "$meta"

      ###############################################
      # 7. Commit meta.yaml
      ###############################################
      - name: Commit updated meta.yaml
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "${{ steps.paths.outputs.meta }}"
          git commit -m "Update ${{ steps.detect.outputs.changed_folder }} to v${{ steps.version.outputs.new_version }} [skip ci]" || true
          git push || true

      ###############################################
      # 8. Create Git Tags
      ###############################################
      - name: Create Release Tags
        id: tags
        run: |
          fw="${{ steps.detect.outputs.changed_folder }}"
          ver="${{ steps.version.outputs.new_version }}"

          tag="${fw}-v${ver}"
          latest="${fw}-latest"

          git tag "$tag"
          git push origin "$tag"

          git tag -f "$latest"
          git push origin -f "$latest"

          echo "tag_name=$tag" >> $GITHUB_OUTPUT

      ###############################################
      # 9. Create GitHub Release
      ###############################################
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tags.outputs.tag_name }}
          name: "Firmware ${{ steps.detect.outputs.changed_folder }} v${{ steps.version.outputs.new_version }}"
          files: |
            ${{ steps.paths.outputs.folder }}/**
          draft: false
          prerelease: false
